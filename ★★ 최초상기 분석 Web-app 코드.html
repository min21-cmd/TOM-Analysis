<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¸Œëœë“œ ìµœì´ˆìƒê¸°ë„ ë¶„ì„ (ì •ë¦¬ë³¸, ì¶”ê°€ì‘ë‹µ=2íšŒì´ìƒ)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; background: rgba(255,255,255,.95); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,.1); overflow: hidden; }
    .header { background: linear-gradient(135deg,#2c3e50,#3498db); color: #fff; padding: 30px; text-align: center; }
    .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 300; }
    .header p { opacity: .9; font-size: 1.1em; }
    .content { padding: 40px; }
    .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
    .upload-card { background: #fff; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,.08); border: 2px dashed #e0e0e0; transition: all .3s ease; }
    .upload-card:hover { border-color: #3498db; transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,.12); }
    .upload-card h3 { color: #2c3e50; margin-bottom: 15px; font-size: 1.4em; display: flex; align-items: center; gap: 10px; }
    .file-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border-color .3s ease; }
    .file-input:focus { outline: none; border-color: #3498db; }
    .keyword-builder { background: #f8f9fa; border-radius: 15px; padding: 25px; max-height: 400px; overflow-y: auto; }
    .brand-row { display: grid; grid-template-columns: 180px 1fr 80px; gap: 10px; align-items: center; margin-bottom: 12px; padding: 12px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
    .brand-input,.keywords-input { padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; }
    .brand-input { font-weight: 600; color: #2c3e50; }
    .brand-input:focus,.keywords-input:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52,152,219,.1); }
    .remove-btn { padding: 6px 12px; background: #e74c3c; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; transition: all .3s ease; }
    .remove-btn:hover { background: #c0392b; }
    .add-btn { width: 100%; padding: 12px; background: linear-gradient(135deg,#27ae60,#2ecc71); color: #fff; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-bottom: 15px; transition: all .3s ease; }
    .add-btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(46,204,113,.3); }
    .help-text { color: #7f8c8d; font-size: 12px; margin-top: 10px; font-style: italic; }
    .analyze-btn { width: 100%; padding: 18px; background: linear-gradient(135deg,#27ae60,#2ecc71); color: #fff; border: none; border-radius: 10px; font-size: 1.2em; font-weight: 600; cursor: pointer; margin: 30px 0; transition: all .3s ease; text-transform: uppercase; letter-spacing: 1px; }
    .analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(46,204,113,.4); }
    .analyze-btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
    .loading { text-align: center; padding: 40px; display: none; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .results { display: none; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 20px; margin-bottom: 40px; }
    .stat-card { background: #fff; border-radius: 12px; padding: 25px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,.08); transition: transform .3s ease; }
    .stat-card:hover { transform: translateY(-3px); }
    .stat-number { font-size: 2.5em; font-weight: bold; color: #3498db; margin-bottom: 10px; }
    .stat-label { color: #7f8c8d; font-size: .9em; text-transform: uppercase; letter-spacing: 1px; }
    .chart-container { background: #fff; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,.08); }
    .chart-title { font-size: 1.5em; color: #2c3e50; margin-bottom: 20px; text-align: center; }
    .table-container { background: #fff; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,.08); overflow-x: auto; }
    .results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .results-table th,.results-table td { padding: 15px; text-align: left; border-bottom: 1px solid #ecf0f1; }
    .results-table th { background: linear-gradient(135deg,#f8f9fa,#e9ecef); font-weight: 600; color: #2c3e50; text-transform: uppercase; font-size: .85em; letter-spacing: 1px; }
    .results-table tr:hover { background: #f8f9fa; }
    .brand-name { font-weight: 600; color: #2c3e50; }
    .frequency { font-weight: bold; color: #27ae60; }
    .percentage { color: #e74c3c; font-weight: 500; }
    .export-buttons { display: flex; gap: 15px; margin-top: 30px; justify-content: center; }
    .export-btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all .3s ease; }
    .export-excel { background: #27ae60; color: #fff; }
    .export-csv { background: #3498db; color: #fff; }
    .export-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,.2); }
    @media (max-width: 768px){ .upload-section{grid-template-columns:1fr} .stats-grid{grid-template-columns:repeat(2,1fr)} .content{padding:20px} .header h1{font-size:2em} .brand-row{grid-template-columns:1fr;gap:8px} .remove-btn{justify-self:end;width:60px} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ë¸Œëœë“œ ìµœì´ˆìƒê¸°ë„ ë¶„ì„</h1>
      <p>Excel íŒŒì¼ê³¼ ë¸Œëœë“œ í‚¤ì›Œë“œë¥¼ ì„¤ì •í•˜ì—¬ ë¸Œëœë“œ ì¸ì§€ë„ë¥¼ ë¶„ì„í•˜ì„¸ìš”</p>
    </div>

    <div class="content">
      <div class="upload-section">
        <div class="upload-card">
          <h3>ğŸ“Š Excel ë°ì´í„° íŒŒì¼</h3>
          <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" />
          <p class="help-text">ì‘ë‹µ ë°ì´í„°ê°€ í¬í•¨ëœ Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>

          <!-- ì»¬ëŸ¼ ì„ íƒ ì˜ì—­ -->
          <div id="columnSelection" style="display:none;margin-top:20px;">
            <label style="display:block;margin-bottom:10px;font-weight:600;color:#2c3e50;">ğŸ“‹ ë¶„ì„í•  ì»¬ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”:</label>
            <select id="columnSelect" class="file-input" style="padding:12px;">
              <option value="">ì»¬ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”...</option>
            </select>
            <div id="dataPreview" style="margin-top:15px;padding:15px;background:#f8f9fa;border-radius:8px;max-height:200px;overflow-y:auto;display:none;">
              <div style="font-weight:600;margin-bottom:10px;color:#2c3e50;">ğŸ“Š ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ì²« 5ê°œ í–‰):</div>
              <div id="previewContent" style="font-size:13px;line-height:1.4;"></div>
            </div>
          </div>
        </div>

        <div class="upload-card">
          <h3>ğŸ·ï¸ ë¸Œëœë“œ í‚¤ì›Œë“œ ì„¤ì •</h3>
          <div class="keyword-builder">
            <div id="brandRows">
              <div class="brand-row">
                <input type="text" class="brand-input" placeholder="ë¸Œëœë“œëª…" />
                <input type="text" class="keywords-input" placeholder="í‚¤ì›Œë“œ1, í‚¤ì›Œë“œ2, ..." />
                <button class="remove-btn" data-action="remove">ì‚­ì œ</button>
              </div>
            </div>
            <button class="add-btn" id="addBrandBtn">+ ë¸Œëœë“œ ì¶”ê°€</button>
            <p class="help-text">ğŸ’¡ ë¸Œëœë“œëª…ì€ ìë™ìœ¼ë¡œ í‚¤ì›Œë“œì— í¬í•¨ë©ë‹ˆë‹¤. ì¶”ê°€ í‚¤ì›Œë“œëŠ” ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì„¸ìš”.</p>
          </div>
        </div>
      </div>

      <button id="analyzeBtn" class="analyze-btn">ë¶„ì„ ì‹œì‘í•˜ê¸°</button>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>

      <div id="results" class="results">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalResponses">0</div>
            <div class="stat-label">ì´ ì‘ë‹µìˆ˜</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="brandResponses">0</div>
            <div class="stat-label">ë¸Œëœë“œ ì‘ë‹µ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="additionalResponses">0</div>
            <div class="stat-label">ì¶”ê°€ ì‘ë‹µ (2íšŒ ì´ìƒ)</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="otherResponses">0</div>
            <div class="stat-label">ê¸°íƒ€</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="unknownResponses">0</div>
            <div class="stat-label">ëª¨ë¦„/ì—†ìŒ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="invalidResponses">0</div>
            <div class="stat-label">ë¶ˆì„±ì‹¤ ì‘ë‹µ</div>
          </div>
        </div>

        <div class="chart-container">
          <h3 class="chart-title">ë¸Œëœë“œë³„ ì‘ë‹µ ë¶„í¬</h3>
          <canvas id="brandChart"></canvas>
        </div>

        <div class="table-container">
          <h3 class="chart-title">ìƒì„¸ ë¶„ì„ ê²°ê³¼</h3>
          <table class="results-table" id="resultsTable">
            <thead>
              <tr>
                <th>ìˆœìœ„</th>
                <th>ë¸Œëœë“œ</th>
                <th>ë¹ˆë„</th>
                <th>ë¹„ìœ¨</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <!-- ì¶”ê°€ ì‘ë‹µ ìƒì„¸ ë‚´ì—­ (2ë²ˆ ì´ìƒ ë“±ì¥) -->
          <div id="additionalResponsesSection" style="display:none;margin-top:30px;">
            <h3 class="chart-title">ì¶”ê°€ ì‘ë‹µ ìƒì„¸ ë‚´ì—­</h3>
            <div style="background:#f8f9fa;border-radius:10px;padding:20px;margin-bottom:20px;">
              <p style="color:#6c757d;margin-bottom:15px;">ğŸ’¡ ë¸Œëœë“œë¡œ ë¶„ë¥˜ë˜ì§€ ì•Šì•˜ì§€ë§Œ <strong>2ë²ˆ ì´ìƒ ë“±ì¥</strong>í•œ ì‘ë‹µë“¤ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ ë¸Œëœë“œë¡œ ì¶”ê°€í•˜ê±°ë‚˜ ê¸°ì¡´ ë¸Œëœë“œì˜ í‚¤ì›Œë“œë¡œ í¬í•¨ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <table class="results-table" id="additionalResponsesTable">
              <thead>
                <tr>
                  <th>ì‘ë‹µ ë‚´ìš©</th>
                  <th>ë“±ì¥ íšŸìˆ˜</th>
                  <th>ë¹„ìœ¨</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="export-buttons">
            <button class="export-btn export-excel" id="exportExcelBtn">Excelë¡œ ë‚´ë³´ë‚´ê¸°</button>
            <button class="export-btn export-csv" id="exportCsvBtn">CSVë¡œ ë‚´ë³´ë‚´ê¸°</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // ì „ì—­ ìƒíƒœ
    // =========================
    let analysisResults = null;
    let chartInstance = null;
    let excelData = null;
    let selectedColumn = null;

    // =========================
    // UI ìœ í‹¸
    // =========================
    function addBrandRow(){
      const container = document.getElementById('brandRows');
      const newRow = document.createElement('div');
      newRow.className = 'brand-row';
      newRow.innerHTML = `
        <input type="text" class="brand-input" placeholder="ë¸Œëœë“œëª…" />
        <input type="text" class="keywords-input" placeholder="ì¶”ê°€ í‚¤ì›Œë“œ (ì„ íƒì‚¬í•­)" />
        <button class="remove-btn" data-action="remove">ì‚­ì œ</button>
      `;
      container.appendChild(newRow);
      newRow.querySelector('.brand-input').focus();
    }

    function removeBrandRow(button){
      const container = document.getElementById('brandRows');
      if(container.children.length>1){ button.closest('.brand-row').remove(); }
      else { alert('ìµœì†Œ í•˜ë‚˜ì˜ ë¸Œëœë“œëŠ” í•„ìš”í•©ë‹ˆë‹¤.'); }
    }

    // ë¸Œëœë“œ ê·¸ë£¹ ìˆ˜ì§‘ (ë¸Œëœë“œëª…ì„ ê¸°ë³¸ í‚¤ì›Œë“œë¡œ í¬í•¨)
    function getBrandGroups(){
      const rows = document.querySelectorAll('.brand-row');
      const brandGroups = {};
      rows.forEach(row=>{
        const brand = row.querySelector('.brand-input').value.trim();
        const add = row.querySelector('.keywords-input').value.trim();
        if(!brand) return;
        const keywords = [brand].concat(add? add.split(',').map(k=>k.trim()).filter(Boolean) : []);
        brandGroups[brand] = keywords;
      });
      return brandGroups;
    }

    // =========================
    // íŒŒì¼ ì½ê¸° + ì»¬ëŸ¼ ì„ íƒ
    // =========================
    function readExcelFileWithColumns(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data,{ type:'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            if(jsonData.length===0){ reject(new Error('Excel íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.')); return; }
            const columns = Object.keys(jsonData[0]);
            const sampleData = jsonData.slice(0,5);
            resolve({ columns, sampleData, fullData: jsonData });
          }catch(err){ reject(err); }
        };
        reader.onerror = ()=>reject(new Error('íŒŒì¼ ì½ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
        reader.readAsArrayBuffer(file);
      });
    }

    function showColumnSelection(columns,sampleData){
      const columnSelection = document.getElementById('columnSelection');
      const columnSelect = document.getElementById('columnSelect');
      columnSelect.innerHTML = '<option value="">ì»¬ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”...</option>';

      const priority = columns.filter(col=> col.toLowerCase().includes('ìµœì´ˆìƒê¸°'));
      if(priority.length){
        const og = document.createElement('optgroup');
        og.label = 'ğŸ¯ ì¶”ì²œ ì»¬ëŸ¼';
        priority.forEach(col=>{ const o=document.createElement('option'); o.value=col; o.textContent=`${col} (ì¶”ì²œ)`; og.appendChild(o); });
        columnSelect.appendChild(og);
      }
      const others = columns.filter(col=> !col.toLowerCase().includes('ìµœì´ˆìƒê¸°'));
      if(others.length){
        const og = document.createElement('optgroup');
        og.label = 'ğŸ“‹ ì „ì²´ ì»¬ëŸ¼';
        others.forEach(col=>{ const o=document.createElement('option'); o.value=col; o.textContent=col; og.appendChild(o); });
        columnSelect.appendChild(og);
      }

      columnSelect.onchange = function(){
        selectedColumn = this.value;
        if(selectedColumn){ showDataPreview(selectedColumn,sampleData); }
        else { document.getElementById('dataPreview').style.display='none'; }
      };

      if(priority.length){
        columnSelect.value = priority[0];
        selectedColumn = priority[0];
        showDataPreview(selectedColumn,sampleData);
      }
      columnSelection.style.display = 'block';
    }

    function showDataPreview(columnName,sampleData){
      const dataPreview = document.getElementById('dataPreview');
      const previewContent = document.getElementById('previewContent');
      let html = `<strong>ì»¬ëŸ¼: ${columnName}</strong><br><br>`;
      sampleData.forEach((row,i)=>{ const v = row[columnName] || '(ë¹ˆ ê°’)'; html += `${i+1}. ${v}<br>`; });
      previewContent.innerHTML = html;
      dataPreview.style.display = 'block';
    }

    async function handleFileUpload(){
      const file = document.getElementById('excelFile').files[0];
      if(!file) return;
      try{
        const data = await readExcelFileWithColumns(file);
        excelData = data;
        showColumnSelection(data.columns, data.sampleData);
      }catch(err){
        console.error(err); alert('íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+err.message);
      }
    }

    // =========================
    // í…ìŠ¤íŠ¸ ë¶„ì„ê¸°
    // =========================
    class TextAnalyzer{
      constructor(brandGroups){
        this.brandGroups = brandGroups;
        this.unknownPatterns = [
          'ëª¨ë¥´','ëª°ë¼','ëª¨ë¦„','ëª¨ë¦…','ëª¨ë¥¸','ëª¨ë¥´ê² ','ëª¨ë£¸','ì—†','ì—†ìŒ','ì—†ìŠµ','ê¸€ì„','ì• ë§¤','ê·¸ëƒ¥','ë¬´','ë­ì§€','ì²˜ìŒ ë“¤ì–´','ì–´ë ¤ì›€','ì–´ë µ','ì´ê²Œ ë­','ì´ê²Œë­”ê°€','ìƒê° ì•ˆ','ìƒê°ì•Š','ê¸°ì–µ ì•ˆ','ê¸°ì–µì•Š','ìƒê°ì´ ì•ˆ','ê¸°ì–µì´ ì•ˆ'
        ];
        this.basicResponses = new Set(['ë„¤','ì•„ë‹ˆì˜¤','ì¢‹ì•„ìš”','ì¢‹ìŠµë‹ˆë‹¤','ê¸°íƒ€','ë¸Œëœë“œ','ê°ì‚¬í•©ë‹ˆë‹¤','í˜¸']);
        this.responseCount = {};
      }
      normalizeText(text){
        if(!text || typeof text!=='string') return '';
        text = text.toLowerCase().trim();
        text = text.replace(/\s+/g,' ');
        text = text.replace(/([ê°€-í£])\s+([ê°€-í£])|([a-z0-9])\s+([a-z0-9])/g,'$1$2$3$4');
        return text.replace(/[^a-z0-9ê°€-í£]/g,'');
      }
      calculateSimilarity(a,b){
        a=this.normalizeText(a); b=this.normalizeText(b);
        let matches=0; const total=Math.max(a.length,b.length);
        for(let i=0;i<Math.min(a.length,b.length);i++){ if(a[i]===b[i]) matches++; }
        return total>0? matches/total : 0;
      }
      matchBrandExact(text){
        const n = this.normalizeText(text);
        for(const [brand,aliases] of Object.entries(this.brandGroups)){
          for(const alias of aliases){ if(n.includes(this.normalizeText(alias))) return brand; }
        }
        return null;
      }
      matchBrandSimilar(text){
        let best=null, score=0.8; // ê°„ë‹¨ ê¸°ì¤€
        for(const [brand,aliases] of Object.entries(this.brandGroups)){
          for(const alias of aliases){
            const s = this.calculateSimilarity(text, alias);
            if(s>score){ score=s; best=brand; }
          }
        }
        return best;
      }
      isUnknownResponse(text){
        const n = this.normalizeText(text);
        if(['x','?','no','nothing',''].includes(n)) return true;
        return this.unknownPatterns.some(p=> n.includes(p));
      }
      checkInvalidResponse(text){
        if(text.length<=1) return 'í•œ ê¸€ì ì‘ë‹µ';
        if(this.basicResponses.has(text)) return 'ê¸°ë³¸ ì‘ë‹µ';
        const charCounts={};
        for(const ch of text){ charCounts[ch]=(charCounts[ch]||0)+1; if(charCounts[ch]>=3) return 'ë¹„ì •ìƒì ì¸ íŒ¨í„´'; }
        return null;
      }
      analyzeResponse(response){
        const n = this.normalizeText(response);
        this.responseCount[n] = (this.responseCount[n]||0)+1;
        const exact = this.matchBrandExact(n); if(exact) return [exact,''];
        const similar = this.matchBrandSimilar(response); if(similar) return [similar,''];
        if(this.isUnknownResponse(n)) return ['ëª¨ë¦„/ì—†ìŒ',''];
        const invalid = this.checkInvalidResponse(n); if(invalid) return ['ë¶ˆì„±ì‹¤ì‘ë‹µ', invalid];
        // â¬‡ï¸ ê·œì¹™ ë³€ê²½: ë™ì¼ ì‘ë‹µì´ 2íšŒ ì´ìƒì¼ ë•Œë§Œ 'ì¶”ê°€ì‘ë‹µ', 1íšŒëŠ” 'ê¸°íƒ€'
        if(this.responseCount[n] >= 2) return ['ì¶”ê°€ì‘ë‹µ',''];
        return ['ê¸°íƒ€',''];
      }
    }

    function analyzeResponses(responses, analyzer){
      const results=[]; const brandCounts={};
      let unknownCount=0, invalidCount=0, additionalCount=0, otherCount=0;
      const firstCategoryByNorm = {}; // ì²« ë¶„ë¥˜ ê¸°ë¡

      for(const r of responses){
        const [cat, reason] = analyzer.analyzeResponse(r);
        const norm = analyzer.normalizeText(r);
        results.push({ ì›ì‘ë‹µ:r, ë¶„ë¥˜ê²°ê³¼:cat, ë¶„ë¥˜ì‚¬ìœ :reason });
        if(!(norm in firstCategoryByNorm)) firstCategoryByNorm[norm] = cat;

        if(Object.keys(analyzer.brandGroups).includes(cat)){
          brandCounts[cat]=(brandCounts[cat]||0)+1;
        }else if(cat==='ëª¨ë¦„/ì—†ìŒ'){
          unknownCount++;
        }else if(cat==='ë¶ˆì„±ì‹¤ì‘ë‹µ'){
          invalidCount++;
        }else if(cat==='ì¶”ê°€ì‘ë‹µ'){
          // ê°œë³„ ê±´ìˆ˜(ë‘ ë²ˆì§¸ ë“±ì¥ë¶€í„°) ì¹´ìš´íŠ¸
          additionalCount++;
        }else{ // ê¸°íƒ€
          otherCount++;
        }
      }

      // âœ” ì¶”ê°€ì‘ë‹µ ë¦¬ìŠ¤íŠ¸: 2íšŒ ì´ìƒ ë“±ì¥í•œ ì‘ë‹µë§Œ ìˆ˜ì§‘
      //   - ë¸Œëœë“œ/ëª¨ë¦„/ë¶ˆì„±ì‹¤ ë¶„ë¥˜ëŠ” ì œì™¸
      //   - í‘œì—ëŠ” ì „ì²´ ë“±ì¥ íšŸìˆ˜ë¥¼ í‘œê¸°
      const additionalResponses = {};
      for(const [norm, cnt] of Object.entries(analyzer.responseCount)){
        if(cnt >= 2){
          const firstCat = firstCategoryByNorm[norm] || 'ê¸°íƒ€';
          const isBrand = Object.keys(analyzer.brandGroups).includes(firstCat);
          const isSpecial = (firstCat==='ëª¨ë¦„/ì—†ìŒ' || firstCat==='ë¶ˆì„±ì‹¤ì‘ë‹µ');
          if(!isBrand && !isSpecial){
            const example = (results.find(x=> analyzer.normalizeText(x.ì›ì‘ë‹µ)===norm) || {}).ì›ì‘ë‹µ || norm;
            additionalResponses[norm] = { response: example, count: cnt };
          }
        }
      }

      return { results, brandCounts, additionalResponses, unknownCount, invalidCount, additionalCount, otherCount, totalResponses: responses.length };
    }

    // =========================
    // í‘œì‹œ/ê·¸ë¦¬ê¸°
    // =========================
    function displayResults(analysisData, brandGroups, columnInfo){
      const { brandCounts, unknownCount, invalidCount, additionalCount, otherCount, totalResponses } = analysisData;
      document.getElementById('totalResponses').textContent = totalResponses.toLocaleString();
      document.getElementById('brandResponses').textContent = Object.values(brandCounts).reduce((a,b)=>a+b,0).toLocaleString();
      document.getElementById('additionalResponses').textContent = additionalCount.toLocaleString();
      document.getElementById('otherResponses').textContent = otherCount.toLocaleString();
      document.getElementById('unknownResponses').textContent = unknownCount.toLocaleString();
      document.getElementById('invalidResponses').textContent = invalidCount.toLocaleString();
      createChart(brandCounts);
      createResultsTable(brandCounts, brandGroups, totalResponses, unknownCount, invalidCount, additionalCount, otherCount, columnInfo);
      createAdditionalResponsesTable(analysisData.additionalResponses, totalResponses);
      document.getElementById('results').style.display = 'block';
    }

    function createChart(brandCounts){
      const ctx = document.getElementById('brandChart').getContext('2d');
      if(chartInstance) chartInstance.destroy();
      const sorted = Object.entries(brandCounts).sort(([,a],[,b])=> b-a).slice(0,10);
      const labels = sorted.map(([b])=>b); const data = sorted.map(([,c])=>c);
      const colors = ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#C9CBCF','#8BC34A','#03A9F4','#F06292'];
      chartInstance = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{ label:'ì‘ë‹µ ìˆ˜', data, backgroundColor: colors.slice(0,data.length), borderColor: colors.slice(0,data.length).map(c=>c+'80'), borderWidth:2 }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 } } }, plugins:{ legend:{ display:false } } }
      });
    }

    function createResultsTable(brandCounts, brandGroups, totalResponses, unknownCount, invalidCount, additionalCount, otherCount, columnInfo){
      const tableContainer = document.querySelector('.table-container');
      let infoHtml='';
      if(columnInfo.source==='selected'){
        infoHtml = `<div style="background:#d1ecf1;border:1px solid #bee5eb;border-radius:8px;padding:15px;margin-bottom:20px;"><div style="color:#0c5460;font-weight:600;margin-bottom:5px;">ğŸ“‹ ë¶„ì„ ì»¬ëŸ¼ ì •ë³´</div><div style="color:#0c5460;font-size:14px;">ì‚¬ìš©ìê°€ ì„ íƒí•œ <strong>"${columnInfo.column}"</strong> ì»¬ëŸ¼ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.</div></div>`;
      }else if(columnInfo.source==='topPriority'){
        infoHtml = `<div style="background:#d4edda;border:1px solid #c3e6cb;border-radius:8px;padding:15px;margin-bottom:20px;"><div style="color:#155724;font-weight:600;margin-bottom:5px;">ğŸ“‹ ë¶„ì„ ì»¬ëŸ¼ ì •ë³´</div><div style="color:#155724;font-size:14px;"><strong>"${columnInfo.column}"</strong> ì»¬ëŸ¼ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.</div></div>`;
      }else{
        infoHtml = `<div style="background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;padding:15px;margin-bottom:20px;"><div style="color:#856404;font-weight:600;margin-bottom:5px;">ğŸ“‹ ë¶„ì„ ì»¬ëŸ¼ ì •ë³´</div><div style="color:#856404;font-size:14px;">'ìµœì´ˆìƒê¸°' ì»¬ëŸ¼ì„ ì°¾ì§€ ëª»í•´ <strong>"${columnInfo.column}"</strong> ì»¬ëŸ¼ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.</div></div>`;
      }

      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML='';
      const sorted = Object.entries(brandCounts).sort(([,a],[,b])=> b-a);
      Object.keys(brandGroups).forEach(brand=>{ if(!brandCounts[brand]) sorted.push([brand,0]); });
      sorted.forEach(([brand,count],i)=>{
        const tr=document.createElement('tr');
        const pct = totalResponses>0? (count/totalResponses*100).toFixed(1) : '0.0';
        tr.innerHTML = `<td>${i+1}</td><td class="brand-name">${brand}</td><td class="frequency">${count.toLocaleString()}</td><td class="percentage">${pct}%</td>`;
        tbody.appendChild(tr);
      });
      const others = [ {name:'ëª¨ë¦„/ì—†ìŒ',count:unknownCount}, {name:'ì¶”ê°€ì‘ë‹µ',count:additionalCount}, {name:'ë¶ˆì„±ì‹¤ì‘ë‹µ',count:invalidCount}, {name:'ê¸°íƒ€',count:otherCount} ];
      others.forEach(({name,count})=>{
        if(count>0){ const tr=document.createElement('tr'); const pct = totalResponses>0? (count/totalResponses*100).toFixed(1) : '0.0'; tr.style.backgroundColor='#f8f9fa'; tr.innerHTML=`<td>-</td><td class="brand-name" style="color:#6c757d;">${name}</td><td class="frequency" style="color:#6c757d;">${count.toLocaleString()}</td><td class="percentage" style="color:#6c757d;">${pct}%</td>`; tbody.appendChild(tr); }
      });

      const existing = tableContainer.querySelector('.column-info'); if(existing) existing.remove();
      const div = document.createElement('div'); div.className='column-info'; div.innerHTML = infoHtml; const title = tableContainer.querySelector('.chart-title'); title.insertAdjacentElement('afterend', div);
    }

    function createAdditionalResponsesTable(additionalResponses,totalResponses){
      const section = document.getElementById('additionalResponsesSection');
      const tbody = document.querySelector('#additionalResponsesTable tbody');
      if(Object.keys(additionalResponses).length===0){ section.style.display='none'; return; }
      tbody.innerHTML='';
      const sorted = Object.entries(additionalResponses).sort(([,a],[,b])=> b.count-a.count);
      sorted.forEach(([key,data])=>{
        const tr=document.createElement('tr');
        const pct = totalResponses>0? (data.count/totalResponses*100).toFixed(1) : '0.0';
        tr.innerHTML = `<td style="font-weight:500;color:#2c3e50;">${data.response}</td><td style="text-align:center;font-weight:bold;color:#e67e22;">${data.count.toLocaleString()}</td><td style="text-align:center;color:#e74c3c;">${pct}%</td>`;
        tbody.appendChild(tr);
      });
      section.style.display='block';
    }

    // =========================
    // ë‚´ë³´ë‚´ê¸°
    // =========================
    function exportToExcel(){
      if(!analysisResults){ alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.'); return; }
      try{
        const wb = XLSX.utils.book_new();
        // 1) ë¸Œëœë“œë³„ ê²°ê³¼
        const brandData = [['ìˆœìœ„','ë¸Œëœë“œ','ë¹ˆë„','ë¹„ìœ¨']];
        const { brandCounts, totalResponses } = analysisResults;
        const sorted = Object.entries(brandCounts).sort(([,a],[,b])=> b-a);
        sorted.forEach(([brand,count],i)=>{ brandData.push([i+1, brand, count, ((count/totalResponses)*100).toFixed(1)+'%']); });
        const other = [ ['ëª¨ë¦„/ì—†ìŒ', analysisResults.unknownCount], ['ì¶”ê°€ì‘ë‹µ', analysisResults.additionalCount], ['ë¶ˆì„±ì‹¤ì‘ë‹µ', analysisResults.invalidCount], ['ê¸°íƒ€', analysisResults.otherCount] ];
        other.forEach(([name,count])=>{ if(count>0) brandData.push(['-', name, count, ((count/totalResponses)*100).toFixed(1)+'%']); });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(brandData), 'ë¸Œëœë“œë³„ ê²°ê³¼');
        // 2) ìƒì„¸ ë¶„ì„ ê³¼ì •
        const detail = [['ì›ì‘ë‹µ','ë¶„ë¥˜ê²°ê³¼','ë¶„ë¥˜ì‚¬ìœ ']];
        analysisResults.results.forEach(r=> detail.push([r.ì›ì‘ë‹µ, r.ë¶„ë¥˜ê²°ê³¼, r.ë¶„ë¥˜ì‚¬ìœ ]) );
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(detail), 'ìƒì„¸ ë¶„ì„ ê³¼ì •');
        // 3) ì¶”ê°€ ì‘ë‹µ ìƒì„¸
        if(analysisResults.additionalResponses && Object.keys(analysisResults.additionalResponses).length){
          const add = [['ì‘ë‹µ ë‚´ìš©','ë“±ì¥ íšŸìˆ˜','ë¹„ìœ¨']];
          const sortedAdd = Object.entries(analysisResults.additionalResponses).sort(([,a],[,b])=> b.count-a.count);
          sortedAdd.forEach(([k,d])=> add.push([d.response, d.count, ((d.count/totalResponses)*100).toFixed(1)+'%']) );
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(add), 'ì¶”ê°€ ì‘ë‹µ ìƒì„¸');
        }
        const today = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `ë¸Œëœë“œ_ë¶„ì„_ê²°ê³¼_${today}.xlsx`);
      }catch(err){ console.error(err); alert('Excel ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜: '+err.message); }
    }

    function exportToCSV(){
      if(!analysisResults){ alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.'); return; }
      try{
        let csv='';
        csv += 'ë¸Œëœë“œë³„ ê²°ê³¼\n';
        csv += 'ìˆœìœ„,ë¸Œëœë“œ,ë¹ˆë„,ë¹„ìœ¨\n';
        const { brandCounts, totalResponses } = analysisResults;
        const sorted = Object.entries(brandCounts).sort(([,a],[,b])=> b-a);
        sorted.forEach(([brand,count],i)=>{ csv += `${i+1},"${brand}",${count},"${((count/totalResponses)*100).toFixed(1)}%"\n`; });
        [['ëª¨ë¦„/ì—†ìŒ',analysisResults.unknownCount],['ì¶”ê°€ì‘ë‹µ',analysisResults.additionalCount],['ë¶ˆì„±ì‹¤ì‘ë‹µ',analysisResults.invalidCount],['ê¸°íƒ€',analysisResults.otherCount]].forEach(([name,count])=>{ if(count>0) csv += `-,"${name}",${count},"${((count/totalResponses)*100).toFixed(1)}%"\n`; });
        csv += '\nìƒì„¸ ë¶„ì„ ê³¼ì •\n';
        csv += 'ì›ì‘ë‹µ,ë¶„ë¥˜ê²°ê³¼,ë¶„ë¥˜ì‚¬ìœ \n';
        analysisResults.results.forEach(r=>{ csv += `"${r.ì›ì‘ë‹µ}","${r.ë¶„ë¥˜ê²°ê³¼}","${r.ë¶„ë¥˜ì‚¬ìœ }"\n`; });
        if(analysisResults.additionalResponses && Object.keys(analysisResults.additionalResponses).length){
          csv += '\nì¶”ê°€ ì‘ë‹µ ìƒì„¸ ë‚´ì—­\n';
          csv += 'ì‘ë‹µ ë‚´ìš©,ë“±ì¥ íšŸìˆ˜,ë¹„ìœ¨\n';
          const sortedAdd = Object.entries(analysisResults.additionalResponses).sort(([,a],[,b])=> b.count-a.count);
          sortedAdd.forEach(([k,d])=>{ csv += `"${d.response}",${d.count},"${((d.count/totalResponses)*100).toFixed(1)}%"\n`; });
        }
        const blob = new Blob(['\uFEFF'+csv],{ type:'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob); link.setAttribute('href',url);
        const today = new Date().toISOString().split('T')[0];
        link.setAttribute('download', `ë¸Œëœë“œ_ë¶„ì„_ê²°ê³¼_${today}.csv`);
        link.style.visibility='hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
      }catch(err){ console.error(err); alert('CSV ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜: '+err.message); }
    }

    // =========================
    // ë¶„ì„ ì‹¤í–‰
    // =========================
    async function analyzeData(){
      if(!excelData || !selectedColumn){ alert('Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë¶„ì„í•  ì»¬ëŸ¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
      const brandGroups = getBrandGroups();
      if(Object.keys(brandGroups).length===0){ alert('ìµœì†Œ í•˜ë‚˜ì˜ ë¸Œëœë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      document.getElementById('analyzeBtn').disabled=true;
      document.getElementById('loading').style.display='block';
      document.getElementById('results').style.display='none';
      try{
        const responses = excelData.fullData.map(row=> row[selectedColumn]).filter(r=> r && r.toString().trim());
        if(responses.length===0) throw new Error('ì„ íƒëœ ì»¬ëŸ¼ì— ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        const analyzer = new TextAnalyzer(brandGroups);
        const results = analyzeResponses(responses, analyzer);
        const columnInfo = { column: selectedColumn, source: selectedColumn.toLowerCase().includes('ìµœì´ˆìƒê¸°')? 'topPriority' : 'selected' };
        displayResults(results, brandGroups, columnInfo);
        analysisResults = results;
      }catch(err){ console.error(err); alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+err.message); }
      finally{ document.getElementById('analyzeBtn').disabled=false; document.getElementById('loading').style.display='none'; }
    }

    // =========================
    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    // =========================
    document.addEventListener('DOMContentLoaded',()=>{
      const fileInput = document.getElementById('excelFile'); if(fileInput) fileInput.addEventListener('change', handleFileUpload);
      const analyzeBtn = document.getElementById('analyzeBtn'); if(analyzeBtn) analyzeBtn.addEventListener('click', analyzeData);
      const addBrandBtn = document.getElementById('addBrandBtn'); if(addBrandBtn) addBrandBtn.addEventListener('click', addBrandRow);
      const brandRows = document.getElementById('brandRows'); if(brandRows){ brandRows.addEventListener('click',(e)=>{ if(e.target.classList.contains('remove-btn')) removeBrandRow(e.target); }); }
      const exportExcelBtn = document.getElementById('exportExcelBtn'); if(exportExcelBtn) exportExcelBtn.addEventListener('click', exportToExcel);
      const exportCsvBtn = document.getElementById('exportCsvBtn'); if(exportCsvBtn) exportCsvBtn.addEventListener('click', exportToCSV);
    });
  </script>
</body>
</html>